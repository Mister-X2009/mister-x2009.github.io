<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>RetroGadgets Blockly</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #1a1a1a;
      color: #fff;
      font-family: sans-serif;
    }
    #blocklyDiv {
      height: 80vh;
      width: 100%;
    }
    #controls {
      padding: 10px;
      background: #111;
      display: flex;
      gap: 10px;
    }
    button {
      background: #00c896;
      color: #000;
      border: none;
      padding: 10px 15px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
    }
    pre {
      background: #000;
      color: #0f0;
      padding: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;color:#00c896;">RetroGadgets Blockly Editor</h1>
  <div id="blocklyDiv"></div>
  <div id="controls">
    <button onclick="showCode()">Lua-Code anzeigen</button>
    <button onclick="downloadCode()">Lua-Code herunterladen</button>
  </div>
  <pre id="code"></pre>

  <xml id="toolbox" style="display:none">
    <category name="Logik" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
    </category>
    <category name="Schleifen" colour="120">
      <block type="controls_repeat_ext"></block>
    </category>
    <category name="Mathe" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
    </category>
    <category name="Variablen" custom="VARIABLE"></category>
    <category name="RetroGadgets" colour="60">
      <block type="rg_clear"></block>
      <block type="rg_setpixel"></block>
      <block type="rg_drawtext"></block>
      <block type="rg_buttonpressed"></block>
    </category>
  </xml>

  <script>
    const workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

    // Custom Blocks
    Blockly.defineBlocksWithJsonArray([
      {
        "type": "rg_clear",
        "message0": "Bildschirm löschen",
        "previousStatement": null,
        "nextStatement": null,
        "colour": 60
      },
      {
        "type": "rg_setpixel",
        "message0": "Pixel bei x %1 y %2 auf Farbe %3 setzen",
        "args0": [
          {"type": "input_value", "name": "X", "check": "Number"},
          {"type": "input_value", "name": "Y", "check": "Number"},
          {"type": "input_value", "name": "COLOR", "check": "String"}
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 60
      },
      {
        "type": "rg_drawtext",
        "message0": "Text %1 bei x %2 y %3 zeichnen",
        "args0": [
          {"type": "input_value", "name": "TEXT", "check": "String"},
          {"type": "input_value", "name": "X", "check": "Number"},
          {"type": "input_value", "name": "Y", "check": "Number"}
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 60
      },
      {
        "type": "rg_buttonpressed",
        "message0": "Taste %1 gedrückt?",
        "args0": [{"type": "field_input", "name": "BUTTON", "text": "A"}],
        "output": "Boolean",
        "colour": 60
      }
    ]);

    // Lua Generator
    Blockly.Lua['rg_clear'] = function() {
      return 'rg.clear()\n';
    };
    Blockly.Lua['rg_setpixel'] = function(block) {
      const x = Blockly.Lua.valueToCode(block, 'X', Blockly.Lua.ORDER_NONE) || 0;
      const y = Blockly.Lua.valueToCode(block, 'Y', Blockly.Lua.ORDER_NONE) || 0;
      const color = Blockly.Lua.valueToCode(block, 'COLOR', Blockly.Lua.ORDER_NONE) || '"white"';
      return `rg.setPixel(${x}, ${y}, ${color})\n`;
    };
    Blockly.Lua['rg_drawtext'] = function(block) {
      const text = Blockly.Lua.valueToCode(block, 'TEXT', Blockly.Lua.ORDER_NONE) || '"Text"';
      const x = Blockly.Lua.valueToCode(block, 'X', Blockly.Lua.ORDER_NONE) || 0;
      const y = Blockly.Lua.valueToCode(block, 'Y', Blockly.Lua.ORDER_NONE) || 0;
      return `rg.drawText(${text}, ${x}, ${y})\n`;
    };
    Blockly.Lua['rg_buttonpressed'] = function(block) {
      const button = block.getFieldValue('BUTTON');
      return [`rg.buttonPressed("${button}")`, Blockly.Lua.ORDER_ATOMIC];
    };

    function showCode() {
      const code = Blockly.Lua.workspaceToCode(workspace);
      document.getElementById('code').textContent = code;
    }

    function downloadCode() {
      const code = Blockly.Lua.workspaceToCode(workspace);
      const blob = new Blob([code], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'script.lua';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
