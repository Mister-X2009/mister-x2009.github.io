<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>RetroGadgets Blockly Modern</title>
  <script src="https://unpkg.com/blockly@12.2.0/blockly.min.js"></script>
  <script src="retro_blocks.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #fff; }
    #blocklyDiv { height: 75vh; width: 100%; }
    #controls { display: flex; gap: 10px; padding: 10px; background: linear-gradient(90deg,#111,#222); border-radius: 12px; justify-content: center; }
    button { border-radius: 8px; background: linear-gradient(90deg,#00c896,#00e6ae); color: #000; font-weight: bold; padding: 10px 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; }
    button:hover { background: linear-gradient(90deg,#00e6ae,#00ffc9); }
    pre { background: #111; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.5); padding: 15px; font-family: 'Fira Code', monospace; color: #0f0; max-height: 20vh; overflow-y: auto; margin: 10px; }
  </style>
</head>
<body>
  <h1 style="text-align:center;color:#00c896;">RetroGadgets Blockly Editor</h1>
  <div id="blocklyDiv"></div>
  <div id="controls">
    <button onclick="showCode()">Lua-Code anzeigen</button>
    <button onclick="downloadCode()">Lua-Code herunterladen</button>
  </div>
  <pre id="code"></pre>

  <!-- Leere Toolbox, wird per JS gefüllt -->
  <xml id="toolbox" style="display:none"></xml>

  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      renderer: 'zelos',
      theme: Blockly.Themes.Dark,
      grid: { spacing: 20, length: 3, colour: '#555', snap: true },
      zoom: { controls: true, wheel: true },
      trashcan: true
    });

    // Blöcke und Toolbox Tabs aus externer Datei einfügen
    addRetroGadgetsBlocks(workspace);
    const toolbox = document.getElementById('toolbox');
    retroGadgetsTabs.forEach(tab => {
      const category = document.createElement('category');
      category.setAttribute('name', tab.category);
      category.setAttribute('colour', tab.colour);
      tab.blocks.forEach(block => {
        const blockXml = document.createElement('block');
        blockXml.setAttribute('type', block.type);
        category.appendChild(blockXml);
      });
      toolbox.appendChild(category);
    });

    // Lua Generatoren
    Blockly.Lua['cpu_block'] = function(block) { const id = block.getFieldValue('ID'); return `CPU(${id})\n`; };
    Blockly.Lua['set_button_light'] = function(block) { const x = block.getFieldValue('X'); const y = block.getFieldValue('Y'); const color = `"${block.getFieldValue('COLOR')}"`; return `rg.setButtonLight(${x},${y},${color})\n`; };
    Blockly.Lua['button_pressed'] = function(block) { const x = block.getFieldValue('X'); const y = block.getFieldValue('Y'); return [`rg.buttonPressed(${x},${y})`, Blockly.Lua.ORDER_ATOMIC]; };
    Blockly.Lua['draw_pixel'] = function(block) { const x = block.getFieldValue('X'); const y = block.getFieldValue('Y'); const color = `"${block.getFieldValue('COLOR')}"`; return `rg.setPixel(${x},${y},${color})\n`; };
    Blockly.Lua['draw_text'] = function(block) { const text = `"${block.getFieldValue('TEXT')}"`; const x = block.getFieldValue('X'); const y = block.getFieldValue('Y'); return `rg.drawText(${text},${x},${y})\n`; };

    function showCode() {
      const code = Blockly.Lua.workspaceToCode(workspace);
      document.getElementById('code').textContent = code;
    }

    function downloadCode() {
      const code = Blockly.Lua.workspaceToCode(workspace);
      const blob = new Blob([code], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'script.lua';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
