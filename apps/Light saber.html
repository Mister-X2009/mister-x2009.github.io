<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saber - Accelerometer Edition</title>
    <style>
        :root {
            --blade-color: #00e5ff;
            --blade-glow: rgba(0, 229, 255, 0.6);
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        #ui-layer {
            position: absolute;
            z-index: 100;
            text-align: center;
            background: rgba(0,0,0,0.9);
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s;
        }

        .hidden { opacity: 0; pointer-events: none; }

        button {
            background: transparent;
            color: var(--blade-color);
            border: 3px solid var(--blade-color);
            padding: 25px 60px;
            font-size: 1.5rem;
            border-radius: 50px;
            text-transform: uppercase;
            box-shadow: 0 0 20px var(--blade-glow);
            cursor: pointer;
        }

        #saber-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 40px;
        }

        #blade {
            width: 20px;
            height: 0%;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 0 10px #fff, 0 0 30px var(--blade-color), 0 0 60px var(--blade-color);
            transition: height 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        .active #blade { height: 75%; }

        #hilt {
            width: 50px;
            height: 200px;
            background: linear-gradient(90deg, #1a1a1a, #444, #1a1a1a);
            border-radius: 4px;
            border-top: 4px solid #000;
        }

        #debug {
            position: absolute;
            top: 10px;
            font-size: 10px;
            color: #444;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="debug">Sensor: Inaktiv</div>

    <div id="ui-layer">
        <h1 style="letter-spacing: 5px;">SABER</h1>
        <p style="color: #666; margin-bottom: 30px;">Optimiert für Beschleunigungssensoren</p>
        <button id="start-btn">Zünden</button>
    </div>

    <div id="saber-container">
        <div id="blade"></div>
        <div id="hilt"></div>
    </div>

    <script>
        let audioCtx, masterGain, humOsc, swingOsc, swingGain, swingFilter;
        let isRunning = false;
        
        // Filter-Variablen (Low-Pass Filter für Sensor)
        let lastAcc = { x: 0, y: 0, z: 0 };
        let smoothedIntensity = 0;
        const FILTER_FACTOR = 0.15; // Je kleiner, desto glatter (aber verzögerter)
        const DEADZONE = 0.8; // Ignoriert kleine Bewegungen

        const debug = document.getElementById('debug');
        const ui = document.getElementById('ui-layer');
        const container = document.getElementById('saber-container');

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Master Gain mit Limiter-Charakteristik
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.6;
            masterGain.connect(audioCtx.destination);

            // Grund-Brummen
            humOsc = audioCtx.createOscillator();
            humOsc.type = 'sawtooth';
            humOsc.frequency.value = 55;
            const humLowpass = audioCtx.createBiquadFilter();
            humLowpass.frequency.value = 140;
            const hGain = audioCtx.createGain();
            hGain.gain.value = 0.12;

            humOsc.connect(humLowpass).connect(hGain).connect(masterGain);
            humOsc.start();

            // Swing Sound (Sägezahn für aggressiven Sound)
            swingOsc = audioCtx.createOscillator();
            swingOsc.type = 'sawtooth';
            swingOsc.frequency.value = 55;
            
            swingFilter = audioCtx.createBiquadFilter();
            swingFilter.type = 'lowpass';
            swingFilter.frequency.value = 100;

            swingGain = audioCtx.createGain();
            swingGain.gain.value = 0;

            swingOsc.connect(swingFilter).connect(swingGain).connect(masterGain);
            swingOsc.start();
        }

        function handleMotion(event) {
            if (!isRunning) return;

            // Wir nehmen acceleration (ohne Schwerkraft) oder accelerationIncludingGravity
            // Beschleunigungssensoren geben bei Bewegung Werte in m/s²
            const acc = event.acceleration || event.accelerationIncludingGravity;
            if (!acc) return;

            // Differenz berechnen (Bewegungsänderung)
            const dx = acc.x - lastAcc.x;
            const dy = acc.y - lastAcc.y;
            const dz = acc.z - lastAcc.z;
            
            // Momentane Bewegungsstärke
            let rawIntensity = Math.sqrt(dx*dx + dy*dy + dz*dz);
            
            // Low-Pass Filter: smoothedIntensity = (alt * 0.85) + (neu * 0.15)
            // Das entfernt das "Zittern" und "Fraggeln"
            if (rawIntensity < DEADZONE) rawIntensity = 0;
            smoothedIntensity = (smoothedIntensity * (1 - FILTER_FACTOR)) + (rawIntensity * FILTER_FACTOR);

            updateSound(smoothedIntensity);
            
            lastAcc.x = acc.x;
            lastAcc.y = acc.y;
            lastAcc.z = acc.z;

            debug.innerText = `Intensität: ${smoothedIntensity.toFixed(2)}`;
        }

        function updateSound(intensity) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;

            // Mapping: Wie stark wirkt sich die Bewegung aus?
            const norm = Math.min(intensity / 8, 1.2); // Gedeckelt bei 1.2

            // Sanfte Parameter-Änderungen ohne Klicken (setTargetAtTime)
            // Volume
            swingGain.gain.setTargetAtTime(norm * 0.7, now, 0.08);
            
            // Frequenz (Pitch-Up beim Schwingen)
            swingOsc.frequency.setTargetAtTime(55 + (norm * 45), now, 0.1);
            
            // Filter (Sound wird heller)
            swingFilter.frequency.setTargetAtTime(100 + (norm * 900), now, 0.1);
        }

        document.getElementById('start-btn').addEventListener('click', async () => {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const p = await DeviceMotionEvent.requestPermission();
                if (p !== 'granted') return;
            }

            initAudio();
            isRunning = true;
            ui.classList.add('hidden');
            container.classList.add('active');
            window.addEventListener('devicemotion', handleMotion, true);
        });

        // Ausschalten beim Tippen auf den Schirm (außer Startbutton)
        document.body.addEventListener('click', (e) => {
            if (isRunning && e.target.id !== 'start-btn') {
                isRunning = false;
                window.removeEventListener('devicemotion', handleMotion);
                ui.classList.remove('hidden');
                container.classList.remove('active');
                if (audioCtx) {
                    masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
                    setTimeout(() => audioCtx.close(), 300);
                }
            }
        });
    </script>
</body>
</html>

