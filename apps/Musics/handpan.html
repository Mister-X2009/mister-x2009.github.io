<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handpan Simulator</title>
    <!-- Lade Tailwind CSS für responsives Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Inter-Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dunkler Hintergrund für Kontrast */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }

        /* Spezielle CSS für die Notenfelder */
        .note-pad {
            width: 90px;
            height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 50%; /* Runde Form */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.1s ease-out;
            border: 3px solid #6b7280;
            user-select: none;
            touch-action: manipulation;
            
            /* Wichtig: position: absolute beibehalten */
            position: absolute;
            /* FIX: top: 50%; und left: 50% hier entfernt, um Konflikte mit dem Ding und den radialen Transforms zu vermeiden. */
        }

        .note-pad:active, .note-pad.active {
            /* !important, um JS-Transform zu überschreiben, falls nötig */
            transform: scale(0.95) !important; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px -1px rgba(0, 0, 0, 0.4), inset 0 0 10px #fcd34d;
            border-color: #fcd34d;
        }

        /* Visueller Effekt beim Spielen */
        .note-pad.playing::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid #fcd34d;
            animation: pulse 0.5s ease-out;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        /* Das zentrale 'Ding' ist größer */
        #ding-pad {
            width: 120px;
            height: 120px;
            background-color: #374151;
            font-size: 1.5rem;
        }
        #ding-pad .key-text {
            font-weight: bold;
        }

    </style>
    <!-- Lade Tone.js für die Klangerzeugung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
</head>
<body class="bg-gray-800 p-4">

    <!-- Hauptcontainer -->
    <div class="w-full max-w-xl bg-gray-700 shadow-2xl rounded-3xl p-6 md:p-10 border-4 border-gray-600">

        <h1 class="text-3xl font-bold text-center text-gray-100 mb-2">Handpan Simulator</h1>
        <p class="text-center text-gray-400 mb-6">Spiele die D-Kurd Skala.</p>

        <!-- Statusmeldung für Audio-Initialisierung -->
        <div id="statusMessage" class="bg-blue-800 border-l-4 border-blue-500 text-blue-100 p-4 mb-6 rounded-xl shadow-inner">
            <p class="font-semibold mb-2">Audio ist deaktiviert</p>
            <p class="text-sm mb-4">Der Browser benötigt eine Geste (Klick/Tipp), um den Ton zu aktivieren.</p>
            <button id="startButton" class="w-full py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition duration-150">
                Ton aktivieren und starten
            </button>
        </div>

        <!-- Handpan-Layout (Simulierte Schale) -->
        <div class="relative flex justify-center items-center bg-gray-600 rounded-full w-full aspect-square max-h-[500px] mx-auto p-4 shadow-inner-xl" style="background: radial-gradient(#4b5563, #1f2937);">
            
            <!-- Das zentrale Ding (D3) - FIX: Zentrierung ist jetzt über diese Tailwind-Klassen garantiert -->
            <div id="ding-pad" 
                 class="note-pad text-gray-100 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" 
                 data-note="D3" 
                 data-key="a">
                <span class="text-xs text-yellow-300">Ding</span>
                <span class="note-text text-2xl font-bold">D3</span>
                <span class="key-text text-sm mt-1 text-gray-300">(A)</span>
            </div>

            <!-- Die Notenfelder (dynamisch positioniert) -->
            <div id="note-pads-container" class="absolute inset-0">
                <!-- Noten werden via JavaScript eingefügt -->
            </div>

        </div>

        <!-- Hinweise -->
        <div class="mt-8 pt-4 border-t border-gray-600">
            <h3 class="text-lg font-semibold text-gray-300 mb-2 text-center">Tastenbelegung (D-Kurd Skala)</h3>
            <div id="key-guide" class="flex justify-center flex-wrap text-sm text-gray-400 gap-x-4 gap-y-2">
                <!-- Tasten werden hier befüllt -->
            </div>
        </div>
    </div>

    <script>
        // --- Tone.js Initialisierung ---
        
        const handpanSynth = new Tone.MembraneSynth({
            pitchDecay: 0.008, 
            octaves: 0.8,
            envelope: {
                attack: 0.001,
                decay: 1.5,
                sustain: 0.0,
                release: 0.5
            }
        });

        const reverb = new Tone.Reverb({
            decay: 3.5,
            wet: 0.3
        }).toDestination();

        const chorus = new Tone.Chorus(4, 2.5, 0.5).connect(reverb);
        handpanSynth.connect(chorus);
        
        const notes = [
            { note: "D3", key: "a", displayKey: "A", isDing: true },
            { note: "A3", key: "s", displayKey: "S" },
            { note: "C4", key: "d", displayKey: "D" },
            { note: "D4", key: "f", displayKey: "F" },
            { note: "F4", key: "g", displayKey: "G" },
            { note: "G4", key: "h", displayKey: "H" },
            { note: "A4", key: "j", displayKey: "J" },
            { note: "C5", key: "k", displayKey: "K" }
        ];

        let keysDown = {};
        let activeTouchNotes = {};

        function playNote(note, element) {
            if (Tone.context.state !== 'running') {
                Tone.start();
                document.getElementById('statusMessage').style.display = 'none';
            }

            handpanSynth.triggerAttackRelease(note, "1.5n");

            if (element) {
                element.classList.add('active', 'playing');
                setTimeout(() => {
                    element.classList.remove('playing');
                }, 50);
            }
        }

        function stopNote(element) {
            if (element) {
                element.classList.remove('active');
            }
        }

        // --- UI-Erzeugung und Event-Handling ---
        const notePadsContainer = document.getElementById('note-pads-container');
        const keyGuideElement = document.getElementById('key-guide');
        const dingPad = document.getElementById('ding-pad');
        const numPads = notes.length - 1;

        // Event-Listener für den Start-Button
        const startButton = document.getElementById('startButton');
        const statusMessage = document.getElementById('statusMessage');

        if (startButton) {
            startButton.addEventListener('click', () => {
                Tone.start();
                statusMessage.style.display = 'none';
            });
        }
        
        // Erzeuge die Tasten-Elemente im DOM
        notes.forEach((item, index) => {
            
            // 1. Tastatur-Anleitung befüllen
            const keyGuideItem = document.createElement('p');
            keyGuideItem.textContent = `${item.note}: ${item.displayKey}`;
            keyGuideElement.appendChild(keyGuideItem);


            if (item.isDing) {
                const element = dingPad;
                setupEvents(element, item.note, item.key);
                return;
            }

            // 2. Die umliegenden Notenfelder erzeugen
            const angle = (index - 1) * (360 / numPads);
            const radius = 150; 

            // Berechne X/Y-Position basierend auf dem Winkel
            const x = radius * Math.cos((angle - 90) * (Math.PI / 180));
            const y = radius * Math.sin((angle - 90) * (Math.PI / 180));

            const button = document.createElement('div');
            // FIX: top/left auf 50% setzen, um den Startpunkt der Radialpositionierung zu bestimmen
            button.style.top = '50%';
            button.style.left = '50%';
            
            button.classList.add(
                'note-pad',
                'bg-gray-500',
                'text-gray-900',
                'text-center'
            );
            button.dataset.note = item.note;
            button.dataset.key = item.key;
            
            // Setze die Position: (Zentrierung auf den Startpunkt) + (Radialer Offset)
            button.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;

            button.innerHTML = `
                <span class="note-text text-xl font-semibold">${item.note}</span>
                <span class="key-text text-xs mt-1 text-gray-700">(${item.displayKey})</span>
            `;

            // 3. Events anhängen
            setupEvents(button, item.note, item.key);
            notePadsContainer.appendChild(button);
        });
        
        // Helper-Funktion zum Einrichten der Touch/Maus-Events
        function setupEvents(element, note, key) {
            let isPressed = false;
            
            const handleStart = (e) => {
                if (e.type.startsWith('touch')) e.preventDefault(); 
                if (isPressed) return;
                isPressed = true;

                playNote(note, element);

                if (e.type === 'touchstart') {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        activeTouchNotes[e.changedTouches[i].identifier] = element;
                    }
                }
            };

            const handleEnd = (e) => {
                if (!isPressed) return;
                isPressed = false;
                stopNote(element);
                
                if (e.type.startsWith('touch')) {
                     for (let i = 0; i < e.changedTouches.length; i++) {
                        delete activeTouchNotes[e.changedTouches[i].identifier];
                    }
                }
            };

            element.addEventListener('mousedown', handleStart);
            element.addEventListener('mouseup', handleEnd);
            element.addEventListener('mouseleave', () => { if(isPressed) handleEnd({}) }); 
            
            // FIX: Touchstart mit { passive: false } für zuverlässigeres preventDefault auf mobilen Geräten
            element.addEventListener('touchstart', handleStart, { passive: false });
            element.addEventListener('touchend', handleEnd);
            element.addEventListener('touchcancel', handleEnd); 
        }


        // --- Tastatureingabe (Desktop) ---

        const keyMap = notes.reduce((map, item) => {
            map[item.key] = item.note;
            return map;
        }, {});
        
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            const note = keyMap[key];
            if (note && !keysDown[key]) {
                e.preventDefault(); 
                keysDown[key] = true;
                
                // Element direkt über den eindeutigen data-key suchen
                const targetElement = document.querySelector(`[data-key="${key}"]`);

                if (targetElement) {
                    playNote(note, targetElement);
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            const note = keyMap[key];
            if (note && keysDown[key]) {
                e.preventDefault();
                delete keysDown[key];
                
                // Element direkt über den eindeutigen data-key suchen
                const targetElement = document.querySelector(`[data-key="${key}"]`);

                if (targetElement) {
                    stopNote(targetElement);
                }
            }
        });
        
        // Initialisiere Tone.js beim Laden, falls nötig
        window.addEventListener('load', () => {
            if (Tone.context.state !== 'running') {
                statusMessage.style.display = 'block';
            } else {
                statusMessage.style.display = 'none';
            }
        });
        
    </script>
</body>
</html>
