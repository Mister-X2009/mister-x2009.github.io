<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Smooth Swing Saber</title>
<style>
  body {
    margin:0;
    background:black;
    color:white;
    font-family:sans-serif;
    text-align:center;
    overflow:hidden;
  }
  #blade {
    position:fixed;
    top:50%;
    left:50%;
    width:20px;
    height:60vh;
    transform:translate(-50%,-50%);
    background:linear-gradient(to top, #0ff, white);
    box-shadow:0 0 40px #0ff, 0 0 80px #0ff;
    border-radius:10px;
  }
  #flash {
    position:fixed;
    inset:0;
    background:white;
    opacity:0;
    pointer-events:none;
  }
  button {
    margin-top:20px;
    padding:12px 24px;
    font-size:18px;
  }
</style>
</head>
<body>

<h2>Smooth Swing Lightsaber</h2>
<button id="startBtn">Aktivieren</button>

<div id="blade"></div>
<div id="flash"></div>

<script>
let audioCtx;
let humOsc1, humOsc2, swingOsc;
let humGain, swingGain, masterGain;
let swingFilter;
let noiseBuffer;

let motionActive = false;
let lastAccel = 0;
let smoothV = 0;

const BASE_FREQ = 50;
const MULTIPLIER = 2.5;
const SWING_SMOOTHING = 0.15;
const CLASH_THRESHOLD = 18;

const flash = document.getElementById("flash");
const btn = document.getElementById("startBtn");

btn.addEventListener("click", async () => {
  await initAudio();
  await requestMotion();
  btn.style.display = "none";
});

async function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.8;
  masterGain.connect(audioCtx.destination);

  // HUM LAYER
  humOsc1 = audioCtx.createOscillator();
  humOsc1.type = "sawtooth";
  humOsc1.frequency.value = BASE_FREQ;

  humOsc2 = audioCtx.createOscillator();
  humOsc2.type = "sine";
  humOsc2.frequency.value = BASE_FREQ * 2;

  humGain = audioCtx.createGain();
  humGain.gain.value = 0.7;

  humOsc1.connect(humGain);
  humOsc2.connect(humGain);

  // SWING LAYER
  swingOsc = audioCtx.createOscillator();
  swingOsc.type = "sawtooth";
  swingOsc.frequency.value = BASE_FREQ;

  swingFilter = audioCtx.createBiquadFilter();
  swingFilter.type = "lowpass";
  swingFilter.frequency.value = 300;

  swingGain = audioCtx.createGain();
  swingGain.gain.value = 0.0;

  swingOsc.connect(swingFilter);
  swingFilter.connect(swingGain);

  humGain.connect(masterGain);
  swingGain.connect(masterGain);

  humOsc1.start();
  humOsc2.start();
  swingOsc.start();

  createNoiseBuffer();
}

function createNoiseBuffer() {
  const bufferSize = audioCtx.sampleRate * 0.2;
  noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    data[i] = Math.random() * 2 - 1;
  }
}

function playClash() {
  const noise = audioCtx.createBufferSource();
  noise.buffer = noiseBuffer;

  const gain = audioCtx.createGain();
  gain.gain.setValueAtTime(1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);

  noise.connect(gain).connect(masterGain);
  noise.start();

  flash.style.opacity = 1;
  setTimeout(() => flash.style.opacity = 0, 50);
}

async function requestMotion() {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const response = await DeviceMotionEvent.requestPermission();
    if (response !== "granted") return;
  }
  window.addEventListener("devicemotion", handleMotion);
  motionActive = true;
}

function handleMotion(e) {
  if (!motionActive) return;

  const rot = e.rotationRate;
  if (!rot) return;

  const vRaw = Math.sqrt(rot.alpha**2 + rot.beta**2 + rot.gamma**2);
  smoothV += (vRaw - smoothV) * SWING_SMOOTHING;

  const freq = BASE_FREQ + smoothV * MULTIPLIER;
  humOsc1.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.02);
  humOsc2.frequency.setTargetAtTime(freq * 2, audioCtx.currentTime, 0.02);
  swingOsc.frequency.setTargetAtTime(freq * 1.5, audioCtx.currentTime, 0.02);

  const swingAmount = Math.min(smoothV / 150, 1);
  humGain.gain.setTargetAtTime(1 - swingAmount, audioCtx.currentTime, 0.05);
  swingGain.gain.setTargetAtTime(swingAmount, audioCtx.currentTime, 0.05);

  swingFilter.frequency.setTargetAtTime(300 + swingAmount * 3000, audioCtx.currentTime, 0.05);

  // Clash detection
  const acc = e.accelerationIncludingGravity;
  if (acc) {
    const aMag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
    const deltaA = Math.abs(aMag - lastAccel);
    if (deltaA > CLASH_THRESHOLD) playClash();
    lastAccel = aMag;
  }
}
</script>
</body>
</html>
