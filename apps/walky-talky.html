<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Walkie-Talkie Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            background-color: #121212;
            touch-action: manipulation;
            font-family: 'Segoe UI', sans-serif;
        }

        .lcd-screen {
            font-family: 'Orbitron', sans-serif;
            background-color: #a8c6a8;
            color: #1a2e1a;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.4);
        }

        .ptt-btn {
            background: radial-gradient(circle, #444, #222);
            transition: all 0.1s ease;
        }

        .ptt-active {
            background: radial-gradient(circle, #ff4444, #991111) !important;
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.5);
            transform: scale(0.96);
        }

        .overlay {
            backdrop-filter: blur(8px);
            display: none;
        }

        .no-select {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm bg-zinc-900 p-8 rounded-[3.5rem] border-[10px] border-zinc-800 shadow-2xl relative overflow-hidden">
        
        <!-- Deko: Antenne & Regler -->
        <div class="absolute -top-10 left-12 w-4 h-20 bg-zinc-800 rounded-full"></div>
        <div class="absolute top-4 right-10 w-8 h-4 bg-zinc-700 rounded-sm shadow-inner"></div>

        <!-- Header mit Settings Button -->
        <div class="flex justify-between items-center mb-4">
            <span class="text-zinc-500 text-[10px] font-bold tracking-widest">VHF TRANSCEIVER</span>
            <button id="open-settings" class="text-zinc-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>

        <!-- LCD Display -->
        <div class="lcd-screen w-full p-4 rounded-xl mb-6 border-4 border-black/20">
            <div class="flex justify-between items-center text-[10px] font-bold opacity-70">
                <span id="display-mode-text">FM MODE</span>
                <span id="status-text">‚óè RX/TX</span>
            </div>
            <div class="text-5xl font-bold text-center my-3 tracking-tighter">
                <span class="text-2xl">CH</span><span id="display-channel">01</span>
            </div>
            <div class="flex justify-between items-center text-[9px] font-bold mt-2">
                <div class="flex gap-1" id="signal-bars">
                    <div class="w-1 h-2 bg-black/40"></div><div class="w-1 h-3 bg-black/40"></div><div class="w-1 h-4 bg-black"></div>
                </div>
                <div id="display-name" class="truncate max-w-[120px]">USER: INITIALIZING...</div>
            </div>
        </div>

        <!-- Haupt-Interface -->
        <div class="flex flex-col items-center gap-8">
            <div class="flex gap-4 w-full">
                <button id="call-btn" class="flex-1 bg-zinc-800 border-b-4 border-zinc-950 text-blue-400 p-3 rounded-2xl text-xs font-black shadow-lg active:border-b-0 active:translate-y-1 transition-all">
                    üîî ALERT
                </button>
                <div class="flex-1 flex flex-col justify-center px-2">
                    <span class="text-[8px] text-zinc-500 uppercase font-black">Volume</span>
                    <div class="h-1.5 w-full bg-zinc-800 rounded-full mt-1">
                        <div class="h-full w-2/3 bg-blue-500 rounded-full"></div>
                    </div>
                </div>
            </div>

            <div class="relative group">
                <button id="ptt-btn" class="no-select w-36 h-36 rounded-full ptt-btn border-[12px] border-zinc-800 text-white font-black text-2xl flex items-center justify-center shadow-2xl">
                    PTT
                </button>
                <div class="absolute -bottom-4 left-1/2 -translate-x-1/2 flex flex-col items-center">
                    <div id="tx-led" class="w-2 h-2 rounded-full bg-zinc-700 mb-1"></div>
                    <span class="text-[9px] text-zinc-500 font-bold tracking-widest uppercase">Push To Talk</span>
                </div>
            </div>
        </div>

        <!-- Lautsprecher-Optik -->
        <div class="mt-12 flex flex-col gap-1.5 opacity-30">
            <div class="flex justify-center gap-1.5"><div class="w-12 h-1 bg-black rounded-full"></div><div class="w-20 h-1 bg-black rounded-full"></div><div class="w-12 h-1 bg-black rounded-full"></div></div>
            <div class="flex justify-center gap-1.5"><div class="w-16 h-1 bg-black rounded-full"></div><div class="w-24 h-1 bg-black rounded-full"></div><div class="w-16 h-1 bg-black rounded-full"></div></div>
            <div class="flex justify-center gap-1.5"><div class="w-12 h-1 bg-black rounded-full"></div><div class="w-20 h-1 bg-black rounded-full"></div><div class="w-12 h-1 bg-black rounded-full"></div></div>
        </div>
    </div>

    <!-- SETTINGS OVERLAY -->
    <div id="settings-overlay" class="overlay fixed inset-0 z-50 flex items-center justify-center p-6">
        <div class="bg-zinc-900 w-full max-w-xs rounded-3xl border-2 border-zinc-700 p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-white font-bold text-xl">Einstellungen</h2>
                <button id="close-settings" class="text-zinc-500 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-zinc-500 text-[10px] uppercase font-bold block mb-1">Dein Rufname (ID)</label>
                    <input type="text" id="input-username" class="w-full bg-zinc-800 text-white p-3 rounded-xl border border-zinc-700 focus:outline-none focus:border-blue-500 transition-colors" placeholder="z.B. Adler-1">
                </div>

                <div>
                    <label class="text-zinc-500 text-[10px] uppercase font-bold block mb-1">Kanal w√§hlen</label>
                    <select id="input-channel" class="w-full bg-zinc-800 text-white p-3 rounded-xl border border-zinc-700 focus:outline-none">
                        <!-- JS filled -->
                    </select>
                </div>

                <div>
                    <label class="text-zinc-500 text-[10px] uppercase font-bold block mb-1">Klingelton-Frequenz (Hz)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="input-ring-freq" min="200" max="2000" step="10" class="flex-1 accent-blue-500">
                        <span id="val-ring-freq" class="text-white text-xs w-12 font-mono">660</span>
                    </div>
                </div>

                <div class="pt-4">
                    <button id="save-settings" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-3 rounded-xl shadow-lg transition-all active:scale-95">
                        SPEICHERN & RESTART
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const CHANNEL_PREFIX = "WALKIE_V3_";
        let state = {
            username: localStorage.getItem('wt_name') || "OPERATOR-" + Math.floor(Math.random()*999),
            channel: localStorage.getItem('wt_chan') || "01",
            ringFreq: parseInt(localStorage.getItem('wt_freq')) || 660,
            mode: 'clean'
        };

        let peer = null;
        let localStream = null;
        let activeCall = null;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- DOM ELEMENTS ---
        const overlay = document.getElementById('settings-overlay');
        const displayChan = document.getElementById('display-channel');
        const displayName = document.getElementById('display-name');
        const pttBtn = document.getElementById('ptt-btn');
        const txLed = document.getElementById('tx-led');
        const chanSelect = document.getElementById('input-channel');
        const freqSlider = document.getElementById('input-ring-freq');

        // Init Channel Select
        for(let i=0; i<=99; i++){
            const v = i.toString().padStart(2, '0');
            chanSelect.innerHTML += `<option value="${v}">CH ${v}</option>`;
        }

        // --- AUDIO ENGINE ---
        function playBip(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'ring') {
                const freq = state.ringFreq;
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                osc.frequency.setValueAtTime(freq * 1.5, audioCtx.currentTime + 0.1);
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'roger') {
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            }
        }

        // --- PEER CORE ---
        function startNetwork() {
            if (peer) peer.destroy();
            
            // Die ID setzt sich aus Prefix + Kanal + Username zusammen
            const fullId = `${CHANNEL_PREFIX}${state.channel}_${state.username}`;
            peer = new Peer(fullId);

            peer.on('open', (id) => {
                displayName.innerText = `ID: ${state.username}`;
                displayChan.innerText = state.channel;
            });

            peer.on('call', (call) => {
                // Nur Calls vom selben Kanal annehmen
                if (call.peer.startsWith(`${CHANNEL_PREFIX}${state.channel}`)) {
                    txLed.style.backgroundColor = '#22c55e'; // Green for RX
                    call.answer();
                    call.on('stream', (stream) => {
                        const audio = new Audio();
                        audio.srcObject = stream;
                        audio.play();
                    });
                    call.on('close', () => {
                        txLed.style.backgroundColor = '';
                        playBip('roger');
                    });
                }
            });

            // Klingelton Empfang
            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    if (data.type === 'ALERT') {
                        // Wir spielen den Sound ab, den der Sender konfiguriert hat!
                        const tempFreq = data.freq || 660;
                        const osc = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        osc.connect(g); g.connect(audioCtx.destination);
                        osc.frequency.setValueAtTime(tempFreq, audioCtx.currentTime);
                        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
                    }
                });
            });
        }

        // --- TRANSMISSION ---
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => localStream = s);

        function startTX() {
            if (!localStream) return;
            pttBtn.classList.add('ptt-active');
            txLed.style.backgroundColor = '#ef4444'; // Red for TX
            
            const partner = prompt("Ziel-Partner ID (z.B. Adler-1):");
            if (partner) {
                const target = `${CHANNEL_PREFIX}${state.channel}_${partner}`;
                activeCall = peer.call(target, localStream);
            }
        }

        function stopTX() {
            pttBtn.classList.remove('ptt-active');
            txLed.style.backgroundColor = '';
            if (activeCall) activeCall.close();
            playBip('roger');
        }

        // --- UI ACTIONS ---
        document.getElementById('open-settings').onclick = () => {
            document.getElementById('input-username').value = state.username;
            document.getElementById('input-channel').value = state.channel;
            freqSlider.value = state.ringFreq;
            document.getElementById('val-ring-freq').innerText = state.ringFreq;
            overlay.style.display = 'flex';
        };

        document.getElementById('close-settings').onclick = () => overlay.style.display = 'none';

        document.getElementById('save-settings').onclick = () => {
            state.username = document.getElementById('input-username').value || state.username;
            state.channel = document.getElementById('input-channel').value;
            state.ringFreq = parseInt(freqSlider.value);
            
            localStorage.setItem('wt_name', state.username);
            localStorage.setItem('wt_chan', state.channel);
            localStorage.setItem('wt_freq', state.ringFreq);
            
            overlay.style.display = 'none';
            startNetwork();
        };

        freqSlider.oninput = () => {
            document.getElementById('val-ring-freq').innerText = freqSlider.value;
        };

        document.getElementById('call-btn').onclick = () => {
            const partner = prompt("Wen m√∂chtest du anklingeln?");
            if (partner) {
                const conn = peer.connect(`${CHANNEL_PREFIX}${state.channel}_${partner}`);
                conn.on('open', () => {
                    conn.send({ type: 'ALERT', freq: state.ringFreq });
                    playBip('ring'); // Selbst h√∂ren
                    setTimeout(() => conn.close(), 500);
                });
            }
        };

        // PTT Listeners
        pttBtn.onmousedown = startTX;
        pttBtn.onmouseup = stopTX;
        pttBtn.ontouchstart = (e) => { e.preventDefault(); startTX(); };
        pttBtn.ontouchend = (e) => { e.preventDefault(); stopTX(); };

        // Start
        startNetwork();
    </script>
</body>
</html>


