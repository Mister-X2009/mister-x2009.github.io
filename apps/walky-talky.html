<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Walkie-Talkie Broadcast</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            background-color: #0f172a;
            touch-action: manipulation;
            font-family: ui-sans-serif, system-ui, sans-serif;
        }

        .lcd-screen {
            font-family: 'Orbitron', sans-serif;
            background-color: #8fb397;
            color: #061a06;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            border: 4px solid #1e293b;
        }

        .ptt-btn {
            background: linear-gradient(145deg, #3f3f46, #18181b);
            box-shadow: 5px 5px 15px #09090b, -2px -2px 10px #3f3f46;
        }

        .ptt-active {
            background: radial-gradient(circle, #ef4444, #7f1d1d) !important;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            transform: scale(0.96);
        }

        .overlay { backdrop-filter: blur(12px); display: none; }
        
        /* Animation fÃ¼r Funkwellen */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .transmitting::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 4px solid #ef4444;
            animation: pulse-ring 1.5s infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm bg-slate-900 p-8 rounded-[3.5rem] border-[12px] border-slate-800 shadow-2xl relative">
        
        <!-- Antenne -->
        <div class="absolute -top-12 left-10 w-5 h-24 bg-gradient-to-b from-slate-700 to-slate-800 rounded-t-full border-x-2 border-slate-900"></div>

        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col">
                <span class="text-slate-500 text-[10px] font-black tracking-tighter">BROADCAST UNIT</span>
                <span id="online-count" class="text-blue-400 text-[9px] font-bold">0 Teilnehmer online</span>
            </div>
            <button id="open-settings" class="bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>

        <!-- LCD Display -->
        <div class="lcd-screen w-full p-4 rounded-xl mb-6 relative overflow-hidden">
            <div class="flex justify-between text-[10px] font-bold opacity-60">
                <span>CHANNEL SCAN</span>
                <span id="status-text">WAITING</span>
            </div>
            <div class="text-5xl font-bold text-center my-2 flex items-center justify-center">
                <span class="text-xl mr-1">CH</span><span id="display-channel">01</span>
            </div>
            <div class="flex justify-between items-end text-[9px] font-bold">
                <div class="flex gap-0.5" id="signal-meter">
                    <div class="w-1.5 h-2 bg-black/20"></div><div class="w-1.5 h-3 bg-black/20"></div><div class="w-1.5 h-4 bg-black/20"></div><div class="w-1.5 h-5 bg-black/20"></div>
                </div>
                <div id="display-name" class="uppercase text-right truncate max-w-[150px]">NAME: ---</div>
            </div>
            <!-- Hintergrund Raster-Effekt -->
            <div class="absolute inset-0 pointer-events-none opacity-10 bg-[radial-gradient(#000_1px,transparent_1px)] [background-size:4px_4px]"></div>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col items-center gap-8">
            <button id="call-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-2xl font-black text-xs tracking-widest shadow-lg transform active:translate-y-1 transition-all">
                ðŸ”” SEND ALERT TO ALL
            </button>

            <div id="ptt-container" class="relative">
                <button id="ptt-btn" class="ptt-btn w-40 h-40 rounded-full border-[10px] border-slate-800 text-slate-400 font-black text-2xl flex items-center justify-center shadow-inner no-select transition-all">
                    PTT
                </button>
                <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 flex flex-col items-center">
                    <div id="tx-indicator" class="w-3 h-3 rounded-full bg-slate-700 shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all"></div>
                    <span class="text-[8px] text-slate-500 font-bold mt-1">TRANSMIT</span>
                </div>
            </div>
        </div>

        <!-- Speaker Grill -->
        <div class="mt-14 flex flex-col items-center gap-1.5 opacity-20">
            <div class="w-3/4 h-1 bg-black rounded-full"></div>
            <div class="w-full h-1 bg-black rounded-full"></div>
            <div class="w-3/4 h-1 bg-black rounded-full"></div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings-overlay" class="overlay fixed inset-0 z-50 flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-xs rounded-3xl border border-slate-700 p-8 shadow-2xl">
            <h2 class="text-white font-bold text-2xl mb-6">Setup</h2>
            
            <div class="space-y-5">
                <div>
                    <label class="text-slate-500 text-[10px] uppercase font-black block mb-2">Rufname (ID)</label>
                    <input type="text" id="input-username" maxlength="15" class="w-full bg-slate-800 text-white p-4 rounded-xl border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>

                <div>
                    <label class="text-slate-500 text-[10px] uppercase font-black block mb-2">Kanal</label>
                    <select id="input-channel" class="w-full bg-slate-800 text-white p-4 rounded-xl border border-slate-700 outline-none appearance-none"></select>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-slate-500 text-[10px] uppercase font-black">Alarm-TonhÃ¶he</label>
                        <span id="val-freq" class="text-blue-400 font-mono text-xs">660Hz</span>
                    </div>
                    <input type="range" id="input-freq" min="300" max="1500" step="50" class="w-full accent-blue-500">
                </div>

                <button id="save-settings" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-xl transition-all active:scale-95 mt-4">
                    ÃœBERNEHMEN
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const APP_ID = "WALKIE_BROADCAST_V1";
        let state = {
            name: localStorage.getItem('wt_name') || "User" + Math.floor(Math.random()*99),
            channel: localStorage.getItem('wt_chan') || "01",
            freq: parseInt(localStorage.getItem('wt_freq')) || 660,
            peersOnChannel: new Set()
        };

        let peer = null;
        let localStream = null;
        let activeCalls = [];
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- DOM ---
        const pttBtn = document.getElementById('ptt-btn');
        const pttContainer = document.getElementById('ptt-container');
        const txIndicator = document.getElementById('tx-indicator');
        const overlay = document.getElementById('settings-overlay');
        const chanDisplay = document.getElementById('display-channel');
        const nameDisplay = document.getElementById('display-name');
        const onlineDisplay = document.getElementById('online-count');
        const statusText = document.getElementById('status-text');

        // Init Channel UI
        const cSelect = document.getElementById('input-channel');
        for(let i=1; i<=20; i++) {
            const v = i.toString().padStart(2, '0');
            cSelect.innerHTML += `<option value="${v}">Frequenz ${v}</option>`;
        }

        // --- CORE FUNCTIONS ---
        function playLocalSound(f, duration = 0.3) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function initNetwork() {
            if (peer) peer.destroy();
            state.peersOnChannel.clear();
            updateOnlineDisplay();
            
            // ID Format: APP_CH_NAME
            const myId = `${APP_ID}_${state.channel}_${state.name}`;
            peer = new Peer(myId);

            peer.on('open', (id) => {
                nameDisplay.innerText = `NAME: ${state.name}`;
                chanDisplay.innerText = state.channel;
                statusText.innerText = "READY";
                // "Hello" Signal an alle schicken (Broadcast Simulation)
                broadcastSignal({ type: 'PRESENCE' });
            });

            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    handleSignal(data, conn.peer);
                });
            });

            peer.on('call', (call) => {
                // Nur annehmen, wenn gleicher Kanal
                if (call.peer.includes(`_${state.channel}_`)) {
                    statusText.innerText = "RX...";
                    txIndicator.style.backgroundColor = "#22c55e";
                    call.answer();
                    call.on('stream', (s) => {
                        const a = new Audio(); a.srcObject = s; a.play();
                    });
                    call.on('close', () => {
                        txIndicator.style.backgroundColor = "";
                        statusText.innerText = "READY";
                        playLocalSound(440, 0.1); // Roger-Beep
                    });
                }
            });
        }

        function handleSignal(data, senderId) {
            const [app, chan, name] = senderId.split('_');
            if (chan !== state.channel) return;

            if (data.type === 'PRESENCE') {
                state.peersOnChannel.add(senderId);
                updateOnlineDisplay();
                // Antwort schicken, damit der neue uns auch kennt
                const conn = peer.connect(senderId);
                conn.on('open', () => conn.send({ type: 'ACK' }));
            } else if (data.type === 'ACK') {
                state.peersOnChannel.add(senderId);
                updateOnlineDisplay();
            } else if (data.type === 'ALERT') {
                playLocalSound(data.freq, 0.5);
                statusText.innerText = "ALERT!";
                setTimeout(() => statusText.innerText = "READY", 2000);
            }
        }

        function broadcastSignal(data) {
            // In einer echten Cloud-Umgebung wÃ¼rden wir hier eine Liste abrufen.
            // In dieser Demo simulieren wir das, indem wir bekannte Peers "anfunken".
            state.peersOnChannel.forEach(pId => {
                const conn = peer.connect(pId);
                conn.on('open', () => {
                    conn.send(data);
                    setTimeout(() => conn.close(), 500);
                });
            });
        }

        function updateOnlineDisplay() {
            onlineDisplay.innerText = `${state.peersOnChannel.size} Teilnehmer online`;
            // Signal Bars simulieren
            const bars = document.getElementById('signal-meter').children;
            for(let i=0; i<bars.length; i++) {
                bars[i].style.backgroundColor = i < state.peersOnChannel.size + 1 ? 'black' : 'rgba(0,0,0,0.1)';
            }
        }

        // --- TRANSMIT ---
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => localStream = s);

        function startTransmit() {
            if (!localStream || state.peersOnChannel.size === 0) {
                if(state.peersOnChannel.size === 0) statusText.innerText = "NO PEERS";
                return;
            }
            pttBtn.classList.add('ptt-active');
            pttContainer.classList.add('transmitting');
            txIndicator.style.backgroundColor = "#ef4444";
            statusText.innerText = "TX ALL";

            state.peersOnChannel.forEach(pId => {
                const call = peer.call(pId, localStream);
                activeCalls.push(call);
            });
        }

        function stopTransmit() {
            pttBtn.classList.remove('ptt-active');
            pttContainer.classList.remove('transmitting');
            txIndicator.style.backgroundColor = "";
            statusText.innerText = "READY";
            activeCalls.forEach(c => c.close());
            activeCalls = [];
            playLocalSound(880, 0.05); // Eigener Roger Beep
        }

        // --- UI EVENTS ---
        document.getElementById('open-settings').onclick = () => {
            document.getElementById('input-username').value = state.name;
            document.getElementById('input-channel').value = state.channel;
            overlay.style.display = 'flex';
        };

        document.getElementById('save-settings').onclick = () => {
            state.name = document.getElementById('input-username').value.replace(/_/g, '') || state.name;
            state.channel = document.getElementById('input-channel').value;
            state.freq = parseInt(document.getElementById('input-freq').value);
            
            localStorage.setItem('wt_name', state.name);
            localStorage.setItem('wt_chan', state.channel);
            localStorage.setItem('wt_freq', state.freq);
            
            overlay.style.display = 'none';
            initNetwork();
        };

        document.getElementById('input-freq').oninput = (e) => {
            document.getElementById('val-freq').innerText = e.target.value + "Hz";
        };

        document.getElementById('call-btn').onclick = () => {
            playLocalSound(state.freq, 0.5); // Selbst hÃ¶ren
            broadcastSignal({ type: 'ALERT', freq: state.freq });
        };

        // PTT Listeners
        const noSelect = (e) => e.preventDefault();
        pttBtn.addEventListener('mousedown', startTransmit);
        window.addEventListener('mouseup', stopTransmit);
        pttBtn.addEventListener('touchstart', (e) => { noSelect(e); startTransmit(); });
        window.addEventListener('touchend', stopTransmit);

        // Initial Start
        initNetwork();
    </script>
</body>
</html>

